<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Face - IVSS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .camera-container {
            position: relative;
            overflow: hidden;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .capture-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            transition: all 0.3s ease;
            transform: scale(1);
        }
        
        .capture-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            transition: all 0.3s ease;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(78, 205, 196, 0.3);
        }
        
        .submit-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: all 0.3s ease;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .preview-image {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
{% extends "base.html" %}
{% block title %}Dashboard - IVSS{% endblock %}
{% block content %}
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-gray-100">


    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                    Face Registration
                </h1>
                <p class="text-gray-400">Capture or upload a face image to register a new person</p>
            </div>

            <!-- Success Message -->
            <div id="successMessage" class="hidden mb-6 p-4 bg-green-500/20 border border-green-500/30 rounded-lg text-green-400 text-center fade-in">
                <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span id="successText"></span>
            </div>

            <!-- Main Form -->
            <div class="glass-effect rounded-2xl p-8 shadow-2xl">
                <form id="registerForm" class="space-y-6">
                    <!-- Person Name Input -->
                    <div class="fade-in">
                        <label for="person_name" class="block text-sm font-semibold mb-3 text-gray-300">
                            Person Name
                        </label>
                        <input 
                            type="text" 
                            name="person_name" 
                            id="person_name" 
                            required 
                            class="input-field w-full p-4 rounded-lg text-gray-200 placeholder-gray-500 outline-none"
                            placeholder="Enter the person's full name"
                        >
                    </div>

                    <!-- Camera and Upload Section -->
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Camera Section -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-300 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                                </svg>
                                Camera Capture
                            </h3>
                            
                            <!-- Camera Selection -->
                            <div class="mb-4">
                                <label for="cameraSelect" class="block text-sm font-medium mb-2 text-gray-400">
                                    Select Camera
                                </label>
                                <select 
                                    id="cameraSelect" 
                                    class="input-field w-full p-3 rounded-lg text-gray-200 outline-none"
                                >
                                    <option value="">Click "Load Cameras" to see available cameras</option>
                                </select>
                            </div>
                            
                            <div class="camera-container bg-gray-800">
                                <video id="video" class="w-full h-64 object-cover" autoplay muted></video>
                                <canvas id="canvas" class="hidden"></canvas>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button 
                                    type="button" 
                                    id="loadCamerasBtn" 
                                    class="upload-btn flex-1 py-3 px-6 rounded-lg font-semibold text-white transition-all duration-300"
                                >
                                    <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4z"/>
                                        <path d="M6 8a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z"/>
                                    </svg>
                                    Load Cameras
                                </button>
                                <button 
                                    type="button" 
                                    id="startCamera" 
                                    class="upload-btn flex-1 py-3 px-6 rounded-lg font-semibold text-white transition-all duration-300"
                                    disabled
                                >
                                    <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M2 6a2 2 0 012-2h6l2 2h6a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
                                    </svg>
                                    Start Camera
                                </button>
                            </div>
                            
                            <button 
                                type="button" 
                                id="captureBtn" 
                                class="capture-btn w-full py-3 px-6 rounded-lg font-semibold text-white transition-all duration-300"
                                disabled
                            >
                                <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                                </svg>
                                Capture Photo
                            </button>
                        </div>

                        <!-- Upload Section -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-300 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                </svg>
                                File Upload
                            </h3>
                            
                            <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:border-purple-400 transition-colors duration-300">
                                <input 
                                    type="file" 
                                    id="face_image" 
                                    accept="image/*" 
                                    class="hidden"
                                >
                                <div id="dropZone" class="cursor-pointer">
                                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                    </svg>
                                    <p class="text-gray-400 mb-2">Click to upload or drag and drop</p>
                                    <p class="text-sm text-gray-500">PNG, JPG, GIF up to 10MB</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Image Preview -->
                    <div id="previewContainer" class="hidden text-center">
                        <h3 class="text-lg font-semibold text-gray-300 mb-4">Preview</h3>
                        <img id="previewImage" class="preview-image mx-auto max-w-sm max-h-64 object-cover">
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center pt-6">
                        <button 
                            type="submit" 
                            id="submitBtn"
                            class="submit-btn py-4 px-8 rounded-lg font-semibold text-white transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"/>
                            </svg>
                            Register Face
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="glass-effect rounded-2xl p-8 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-purple-500 mx-auto mb-4"></div>
            <p class="text-gray-300">Processing face registration...</p>
        </div>
    </div>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let capturedImage = null;
        let stream = null;
        let availableCameras = [];

        // DOM elements
        const loadCamerasBtn = document.getElementById('loadCamerasBtn');
        const cameraSelect = document.getElementById('cameraSelect');
        const startCameraBtn = document.getElementById('startCamera');
        const captureBtn = document.getElementById('captureBtn');
        const fileInput = document.getElementById('face_image');
        const dropZone = document.getElementById('dropZone');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const submitBtn = document.getElementById('submitBtn');
        const personNameInput = document.getElementById('person_name');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successText');

        // Load available cameras
        loadCamerasBtn.addEventListener('click', async () => {
            try {
                console.log("ðŸ” Loading available cameras...");
                
                // Request permission first
                const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                tempStream.getTracks().forEach(track => track.stop());
                
                // Get all devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                
                // Clear existing options
                cameraSelect.innerHTML = '';
                
                if (availableCameras.length === 0) {
                    cameraSelect.innerHTML = '<option value="">No cameras found</option>';
                    return;
                }
                
                // Add camera options
                availableCameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.textContent = camera.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
                // Enable start camera button
                startCameraBtn.disabled = false;
                loadCamerasBtn.textContent = 'Cameras Loaded';
                loadCamerasBtn.classList.add('bg-green-600');
                
                console.log(`âœ… Found ${availableCameras.length} cameras`);
                
            } catch (err) {
                console.error('Error loading cameras:', err);
                alert('Error loading cameras: ' + err.message);
            }
        });

        // Start camera with selected device
        startCameraBtn.addEventListener('click', async () => {
            try {
                const selectedDeviceId = cameraSelect.value;
                
                if (!selectedDeviceId) {
                    alert('Please select a camera first');
                    return;
                }
                
                console.log("ðŸ“· Starting camera with device ID:", selectedDeviceId);
                
                // Stop existing stream if any
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Start new stream with selected camera
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        deviceId: { exact: selectedDeviceId },
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });

                video.srcObject = stream;
                await video.play();

                console.log("âœ… Camera started successfully");

                // Update UI
                captureBtn.disabled = false;
                startCameraBtn.textContent = 'Camera Active';
                startCameraBtn.classList.add('bg-green-600');
                startCameraBtn.classList.remove('bg-blue-600');
                
            } catch (err) {
                console.error('Error starting camera:', err);
                alert('Error starting camera: ' + err.message);
            }
        });

        // Capture image
        captureBtn.addEventListener('click', () => {
            if (!video.videoWidth || !video.videoHeight) {
                alert('Camera not ready. Please wait for the video to load.');
                return;
            }
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                capturedImage = blob;
                const url = URL.createObjectURL(blob);
                showPreview(url);
            }, 'image/jpeg', 0.9);
        });

        // File upload
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                capturedImage = file;
                const url = URL.createObjectURL(file);
                showPreview(url);
            }
        });

        // Drag and drop
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-purple-400');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-purple-400');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-purple-400');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                capturedImage = file;
                const url = URL.createObjectURL(file);
                showPreview(url);
            }
        });

        // Show preview
        function showPreview(url) {
            previewImage.src = url;
            previewContainer.classList.remove('hidden');
            previewContainer.classList.add('fade-in');
            updateSubmitButton();
        }

        // Update submit button state
        function updateSubmitButton() {
            const hasName = personNameInput.value.trim() !== '';
            const hasImage = capturedImage !== null;
            submitBtn.disabled = !(hasName && hasImage);
        }

        personNameInput.addEventListener('input', updateSubmitButton);

        // Form submission
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!capturedImage || !personNameInput.value.trim()) {
                alert('Please provide both a name and an image.');
                return;
            }

            const formData = new FormData();
            formData.append('person_name', personNameInput.value.trim());
            formData.append('face_image', capturedImage);

            loadingOverlay.classList.remove('hidden');

            try {
                const response = await fetch('/register_face', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.text();
                
                if (response.ok) {
                    showSuccess('Face registered successfully!');
                    resetForm();
                } else {
                    throw new Error(result);
                }
            } catch (error) {
                alert('Error registering face: ' + error.message);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        });

        // Show success message
        function showSuccess(message) {
            successText.textContent = message;
            successMessage.classList.remove('hidden');
            setTimeout(() => {
                successMessage.classList.add('hidden');
            }, 5000);
        }

        // Reset form
        function resetForm() {
            personNameInput.value = '';
            capturedImage = null;
            previewContainer.classList.add('hidden');
            fileInput.value = '';
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            video.srcObject = null;
            captureBtn.disabled = true;
            startCameraBtn.disabled = true;
            startCameraBtn.textContent = 'Start Camera';
            startCameraBtn.classList.remove('bg-green-600');
            startCameraBtn.classList.add('bg-blue-600');
            
            cameraSelect.innerHTML = '<option value="">Click "Load Cameras" to see available cameras</option>';
            loadCamerasBtn.textContent = 'Load Cameras';
            loadCamerasBtn.classList.remove('bg-green-600');
            
            updateSubmitButton();
        }

        // Initial state
        updateSubmitButton();
    </script>
</body>
{% endblock %}
