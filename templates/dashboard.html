{% extends "base.html" %}
{% block title %}Dashboard - IVSS{% endblock %}
{% block content %}

<style>
    .glass-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .stat-card {
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: .7;
        }
    }
    
    .camera-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
    }

    /* Toggle Switch Styles */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 80px;
        height: 40px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        transition: all 0.4s ease;
        border-radius: 40px;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 28px;
        width: 28px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: all 0.4s ease;
        border-radius: 50%;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    input:checked + .slider {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    input:focus + .slider {
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }

    input:checked + .slider:before {
        transform: translateX(40px);
    }

    .system-status-indicator {
        transition: all 0.3s ease;
    }
</style>

<div class="container mx-auto px-6 py-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white mb-2">Surveillance Dashboard</h1>
            <p class="text-white/70">Monitor your security system in real-time</p>
        </div>
        <div class="flex items-center space-x-2 text-white/70">
            {% if system_running %}
                <div class="w-2 h-2 bg-green-400 rounded-full pulse"></div>
                <span class="text-sm">System Online</span>
            {% else %}
                <div class="w-2 h-2 bg-red-400 rounded-full"></div>
                <span class="text-sm">System Offline</span>
            {% endif %}
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Active Cameras -->
        <div class="stat-card glass-card rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/70 text-sm uppercase tracking-wide">Active Cameras</p>
                    <p class="text-3xl font-bold mt-2">{{ camera_ids|length }}</p>
                    <div class="flex items-center mt-2">
                        <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                        <span class="text-xs text-white/70">All operational</span>
                    </div>
                </div>
                <div class="bg-blue-500/20 p-3 rounded-lg">
                    <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Registered Faces -->
        <div class="stat-card glass-card rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/70 text-sm uppercase tracking-wide">Registered Faces</p>
                    <p class="text-3xl font-bold mt-2">{{ encodings_count }}</p>
                    <div class="flex items-center mt-2">
                        <span class="text-xs text-green-400">Database loaded</span>
                    </div>
                </div>
                <div class="bg-purple-500/20 p-3 rounded-lg">
                    <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Security Alerts -->
        <div class="stat-card glass-card rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/70 text-sm uppercase tracking-wide">Security Alerts</p>
                    <p class="text-3xl font-bold mt-2">{{ alert_count }}</p>
                    <div class="flex items-center space-x-4 mt-2 text-xs">
                        <span class="text-red-400">üÜï {{ new_alerts }}</span>
                        <span class="text-yellow-400">‚úÖ {{ acknowledged_alerts }}</span>
                        <span class="text-green-400">‚úîÔ∏è {{ resolved_alerts }}</span>
                    </div>
                </div>
                <div class="bg-red-500/20 p-3 rounded-lg">
                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Users -->
        <div class="stat-card glass-card rounded-xl p-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/70 text-sm uppercase tracking-wide">Total Users</p>
                    <p class="text-3xl font-bold mt-2">{{ total_users }}</p>
                    <div class="flex flex-col space-y-1 mt-2 text-xs">
                        <span class="text-white/70">üîê {{ admin_count }} Admins</span>
                        <span class="text-white/70">üëÆ {{ moderator_count }} Moderators</span>
                    </div>
                </div>
                <div class="bg-green-500/20 p-3 rounded-lg">
                    <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Alert Trends -->
        <div class="glass-card rounded-xl p-6">
            <h3 class="text-white text-lg font-semibold mb-4">Alert Trends (Last 7 Days)</h3>
            <div class="relative h-64">
                <canvas id="alertChart"></canvas>
            </div>
        </div>

        <!-- Alert Status Distribution -->
        <div class="glass-card rounded-xl p-6">
            <h3 class="text-white text-lg font-semibold mb-4">Alert Status Distribution</h3>
            <div class="relative h-64">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Admin System Controls (only visible to admins) -->
    {% if current_user.is_admin() %}
    <div class="glass-card rounded-xl p-6 mb-8">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div>
                    <h3 class="text-white text-lg font-semibold">System Controls</h3>
                    <p class="text-white/70 text-sm mt-1">Admin-only system management</p>
                </div>
                
                <!-- System Status Indicator -->
                <div class="system-status-indicator flex items-center space-x-3 ml-8">
                    {% if system_running %}
                        <div class="flex items-center space-x-2 px-3 py-2 bg-green-500/20 border border-green-500/30 rounded-lg">
                            <div class="w-2 h-2 bg-green-400 rounded-full pulse"></div>
                            <span class="text-green-300 text-sm font-medium">System Active</span>
                        </div>
                    {% else %}
                        <div class="flex items-center space-x-2 px-3 py-2 bg-red-500/20 border border-red-500/30 rounded-lg">
                            <div class="w-2 h-2 bg-red-400 rounded-full"></div>
                            <span class="text-red-300 text-sm font-medium">System Inactive</span>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Toggle Switch -->
            <div class="flex items-center space-x-4">
                <span class="text-white/70 text-sm">
                    {% if system_running %}ON{% else %}OFF{% endif %}
                </span>
                <form action="{{ url_for('toggle_system') }}" method="post" class="inline" id="systemToggleForm">
                    <label class="toggle-switch">
                        <input type="checkbox" {% if system_running %}checked{% endif %} onchange="document.getElementById('systemToggleForm').submit();">
                        <span class="slider"></span>
                    </label>
                </form>
            </div>
        </div>
        
        <!-- Additional System Info -->
        <div class="mt-4 pt-4 border-t border-white/10">
            <div class="flex items-center justify-between text-sm text-white/70">
                <div class="flex items-center space-x-6">
                    <span>Last Updated: <span id="lastUpdate">Just now</span></span>
                    <span>Uptime: <span id="systemUptime">{% if system_running %}Running{% else %}Stopped{% endif %}</span></span>
                </div>
                <button onclick="location.reload()" class="px-3 py-1 bg-blue-500/20 border border-blue-500/30 text-blue-300 rounded hover:bg-blue-500/30 transition-all duration-300">
                    üîÑ Refresh Status
                </button>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<!-- Pass Flask data to JavaScript safely using JSON -->
<script type="text/javascript">
    window.dashboardData = {{ {
        "new_alerts": new_alerts|default(0),
        "acknowledged_alerts": acknowledged_alerts|default(0),
        "resolved_alerts": resolved_alerts|default(0),
        "alert_count": alert_count|default(0),
        "system_running": system_running|default(false)
    } | tojson }};
</script>

<!-- Load Chart.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<!-- Main dashboard JavaScript -->
<script type="text/javascript">
    // Update last update time
    function updateTimestamp() {
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        const lastUpdateEl = document.getElementById('lastUpdate');
        if (lastUpdateEl) {
            lastUpdateEl.textContent = timeString;
        }
    }

    // Initialize charts after Chart.js is loaded
    function initializeCharts() {
        // Ensure we have the data and Chart.js is loaded
        if (typeof window.dashboardData === 'undefined') {
            console.error('Dashboard data not loaded');
            return;
        }
        
        if (typeof Chart === 'undefined') {
            console.error('Chart.js not loaded yet');
            setTimeout(initializeCharts, 100);
            return;
        }

        const alertData = window.dashboardData;
        console.log('Dashboard data:', alertData); // Debug log
        
        // Destroy any existing charts to prevent conflicts
        if (window.alertChart && typeof window.alertChart.destroy === 'function') {
            window.alertChart.destroy();
        }
        if (window.statusChart && typeof window.statusChart.destroy === 'function') {
            window.statusChart.destroy();
        }

        // Initialize chart variables
        window.alertChart = null;
        window.statusChart = null;

        // Alert Trends Chart
        const alertCtx = document.getElementById('alertChart');
        if (alertCtx) {
            try {
                window.alertChart = new Chart(alertCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Alerts',
                            data: [2, 5, 3, 8, 4, 6, alertData.alert_count || 1],
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    stepSize: 1
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        },
                        elements: {
                            point: {
                                radius: 4,
                                hoverRadius: 6
                            }
                        }
                    }
                });
                console.log('Alert chart created successfully');
            } catch (error) {
                console.error('Error creating alert chart:', error);
            }
        } else {
            console.error('Alert chart canvas not found');
        }

        // Status Chart with real data
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            const chartData = [alertData.new_alerts, alertData.acknowledged_alerts, alertData.resolved_alerts];
            const hasData = chartData.some(value => value > 0);
            
            if (hasData) {
                try {
                    window.statusChart = new Chart(statusCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['New', 'Acknowledged', 'Resolved'],
                            datasets: [{
                                data: chartData,
                                backgroundColor: [
                                    '#ef4444',
                                    '#f59e0b',
                                    '#10b981'
                                ],
                                borderWidth: 2,
                                borderColor: 'rgba(255, 255, 255, 0.1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        padding: 15,
                                        usePointStyle: true,
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log('Status chart created successfully');
                } catch (error) {
                    console.error('Error creating status chart:', error);
                }
            } else {
                // Show "No alerts" message when there's no data
                try {
                    const ctx = statusCtx.getContext('2d');
                    ctx.clearRect(0, 0, statusCtx.width, statusCtx.height);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('No alerts to display', statusCtx.width / 2, statusCtx.height / 2);
                    console.log('No data message displayed for status chart');
                } catch (error) {
                    console.error('Error displaying no data message:', error);
                }
            }
        } else {
            console.error('Status chart canvas not found');
        }
    }

    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing charts...');
        initializeCharts();
        updateTimestamp();
        
        // Update timestamp every minute
        setInterval(updateTimestamp, 60000);
    });

    // Handle window resize to prevent chart distortion
    window.addEventListener('resize', function() {
        if (window.alertChart && typeof window.alertChart.resize === 'function') {
            window.alertChart.resize();
        }
        if (window.statusChart && typeof window.statusChart.resize === 'function') {
            window.statusChart.resize();
        }
    });
</script>

{% endblock %}